@model List<Task4.Models.User>

@{
    ViewBag.Title = "Users";
}

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>User management</h3>
        <a href="/Account/Logout" class="btn btn-outline-secondary">Logout</a>
    </div>

    <!-- TOAST -->
    @if (TempData["msg"] != null)
    {
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="mainToast" class="toast align-items-center text-bg-dark border-0">
                <div class="d-flex">
                    <div class="toast-body">
                        @TempData["msg"]
                    </div>
                    <button type="button"
                            class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast">
                    </button>
                </div>
            </div>
        </div>
    }

    <form method="post">

        <!-- TOOLBAR -->
        <div class="toolbar mb-3 d-flex gap-2">

            <!-- ВСЕГДА АКТИВНА -->
            <button formaction="/Users/Block"
                    class="btn btn-danger"
                    id="btnBlock">
                Block
            </button>

            <!-- АКТИВНА ТОЛЬКО ЕСЛИ ВЫБРАНЫ -->
            <button formaction="/Users/Unblock"
                    class="btn btn-light toolbar-btn"
                    id="btnUnblock"
                    disabled
                    title="Unblock users">
                <img src="/images/unblock.png" />
            </button>

            <button formaction="/Users/Delete"
                    class="btn btn-light toolbar-btn"
                    id="btnDelete"
                    disabled
                    title="Delete users">
                <img src="/images/delete.png" />
            </button>

            <!-- ВСЕГДА АКТИВНА -->
            <button formaction="/Users/DeleteUnverified"
                    class="btn btn-light toolbar-btn"
                    id="btnDeleteUnverified"
                    title="Delete unverified users">
                <img src="/images/trash.png" />
            </button>

        </div>

        <!-- TABLE -->
        <table class="table table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th style="width:40px;">
                        <input type="checkbox" id="selectAll" />
                    </th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Last login</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var u in Model)
                {
                    <tr>
                        <td>
                            <input type="checkbox"
                                   name="userIds"
                                   value="@u.Id"
                                   class="user-checkbox" />
                        </td>
                        <td>@u.Name</td>
                        <td>@u.Email</td>
                        <td>
                            @if (u.Status == Task4.Models.UserStatus.Active)
                            {
                                <span class="status-active">Active</span>
                            }
                            else if (u.Status == Task4.Models.UserStatus.Blocked)
                            {
                                <span class="status-blocked">Blocked</span>
                            }
                            else
                            {
                                <span class="status-unverified">Unverified</span>
                            }
                        </td>
                        <td>@u.LastLoginAt</td>
                    </tr>
                }
            </tbody>
        </table>

    </form>

    <!-- PAGINATION -->
    <div class="pagination-bar d-flex justify-content-center mt-4">

        <form method="get" class="d-flex align-items-center gap-2">

            <span>Page:</span>

            <input type="number"
                   name="page"
                   min="1"
                   max="@ViewBag.TotalPages"
                   value="@ViewBag.CurrentPage"
                   class="form-control"
                   style="width:90px;" />

            <button class="btn btn-outline-primary">Go</button>

            <span class="ms-2">of @ViewBag.TotalPages</span>

        </form>

    </div>

</div>

<style>
    .toolbar-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 38px;
        padding: 0;
    }

        .toolbar-btn img {
            height: 18px;
        }
</style>

@section Scripts {
    <script>

        const checkboxes = document.querySelectorAll(".user-checkbox");
        const selectAll = document.getElementById("selectAll");

        const btnUnblock = document.getElementById("btnUnblock");
        const btnDelete = document.getElementById("btnDelete");

        function updateToolbarState() {
            let anyChecked = false;

            checkboxes.forEach(cb => {
                if (cb.checked) anyChecked = true;
            });

            btnUnblock.disabled = !anyChecked;
            btnDelete.disabled = !anyChecked;
        }

        // select all
        selectAll.addEventListener("change", function () {
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateToolbarState();
        });

        // individual checkbox
        checkboxes.forEach(cb => {
            cb.addEventListener("change", updateToolbarState);
        });

        // toast init
        document.addEventListener("DOMContentLoaded", function () {
            const toastEl = document.getElementById('mainToast');
            if (toastEl) {
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

    </script>
}